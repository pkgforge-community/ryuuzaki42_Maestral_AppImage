name: Create new realease
on: [push]

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@main
    - name: install fuse and libfuse2
      run: sudo apt install fuse libfuse2

    - name: Get appimagetool
      run: |
        set -x
        wget https://github.com/AppImage/AppImageKit/releases/download/13/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage
        ls -lah

    - name: Get pyhton
      run: |
        set -x
        wget https://github.com/niess/python-appimage/releases/download/python3.9/python3.9.16-cp39-cp39-manylinux_2_24_x86_64.AppImage
        chmod +x python3.9.16-cp39-cp39-manylinux_2_24_x86_64.AppImage

    - name: Make AppImage
      run: |
        set -x
        ./python3.9.16-cp39-cp39-manylinux_2_24_x86_64.AppImage --appimage-extract

        cd squashfs-root/opt/python3.9/bin/
        ./pip3.9 install --upgrade 'maestral[gui]'
        cd ../lib/
        ./python3.9 -m pip install --upgrade pip

        #opt/python3.9/bin/maestral
        chmod +x AppRun
        #./AppRun
        #./AppRun gui
        #cd ../
        ARCH=x86_64 appimagetool-x86_64.AppImage squashfs-root/

        #./Maestral-x86_64.AppImage 
        #./Maestral-x86_64.AppImage gui

    # Build - Error: Resource not accessible by integration
    # Change Settings -> Actions -> General -> Workflow Permissions to allow read and write:
    # https://github.com/actions/first-interaction/issues/10#issuecomment-1506118886

    # https://github.com/marketplace/actions/upload-to-github-release
    - uses: xresloader/upload-to-github-release@main
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
          file: "out/Authy*.AppImage; out/Authy*.md5"
          #delete_file: "random-name-*.txt;random-*.txt"
          release_id: ${{ steps.create_release.outputs.id }}
          #overwrite: true
          verbose: true
          #tags: true
          draft: false
